name: Build Chromium Portable

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Tạo thư mục
      run: mkdir Chromium_Portable

    - name: Tải Chromium
      run: |
        $url = (Invoke-RestMethod "https://api.github.com/repos/Hibbiki/chromium-win64/releases/latest").assets[0].browser_download_url
        curl -sSL $url -o chrome.7z

    - name: Tải và giải nén
      run: |
        curl -sSL https://www.7-zip.org/a/7zr.exe -o 7zr.exe
        ./7zr.exe x chrome.7z

    - name: Đổi tên và di chuyển
      run: |
        mv Chrome-bin Chromium
        mv Chromium Chromium_Portable/

    - name: Tải chrome_plus
      run: |
        $url = (Invoke-RestMethod "https://api.github.com/repos/Bush2021/chrome_plus/releases/latest").assets[0].browser_download_url
        curl -sSL $url -o chrome_plus.7z
        ./7zr.exe x chrome_plus.7z

    - name: Copy version.dll
      run: |
        $dll = Get-ChildItem -Recurse -Filter "version.dll" | Select -First 1
        cp $dll.FullName Chromium_Portable/Chromium/

    - name: Copy config files
      run: |
        cp chrome++.ini Chromium_Portable/Chromium/
        cp debloater.reg Chromium_Portable/Chromium/
        cp default-apps-multi-profile.bat Chromium_Portable/Chromium/

    - name: Lấy version Chromium
      run: |
        $ver = (Get-Item "Chromium_Portable/Chromium/chrome.exe").VersionInfo.ProductVersion
        echo "CHROMIUM_VER=$ver" >> $env:GITHUB_ENV

    - name: Copy WidevineCdm
      run: |
        mkdir -p "Chromium_Portable/Chromium/$env:CHROMIUM_VER"
        cp -r WidevineCdm "Chromium_Portable/Chromium/$env:CHROMIUM_VER/"

    - name: Lấy version chrome_plus
      run: |
        $plus_ver = (Invoke-RestMethod "https://api.github.com/repos/Bush2021/chrome_plus/releases/latest").tag_name
        echo "PLUS_VER=$plus_ver" >> $env:GITHUB_ENV

    - name: Nén thành zip
      run: |
        $zip_name = "chromium-portable-x64_$env:CHROMIUM_VER_$env:PLUS_VER.zip"
        Compress-Archive -Path Chromium_Portable -DestinationPath $zip_name
        echo "ZIP_NAME=$zip_name" >> $env:GITHUB_ENV

    - name: Tạo Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ZIP_NAME }}
        tag_name: portable-${{ env.CHROMIUM_VER }}-${{ env.PLUS_VER }}
        name: Chromium Portable ${{ env.CHROMIUM_VER }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
