name: Build Chromium Portable Release

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if release exists'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Chạy hàng ngày lúc 02:00 UTC để kiểm tra phiên bản mới
    - cron: '0 2 * * *'

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get latest Chromium version
      id: chromium-version
      run: |
        $release = Invoke-RestMethod "https://api.github.com/repos/Hibbiki/chromium-win64/releases/latest"
        $version = $release.tag_name -replace '^v', ''
        echo "CHROMIUM_VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "CHROMIUM_TAG=$($release.tag_name)" >> $env:GITHUB_OUTPUT
        echo "Found Chromium version: $version"

    - name: Get latest Chrome++ version
      id: chromeplus-version
      run: |
        $release = Invoke-RestMethod "https://api.github.com/repos/Bush2021/chrome_plus/releases/latest"
        $version = $release.tag_name -replace '^v', ''
        echo "CHROMEPLUS_VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Found Chrome++ version: $version"

    - name: Check if release exists
      id: check-release
      run: |
        $releaseName = "chromium-portable-x64_v${{ steps.chromium-version.outputs.CHROMIUM_VERSION }}_${{ steps.chromeplus-version.outputs.CHROMEPLUS_VERSION }}"
        echo "RELEASE_NAME=$releaseName" >> $env:GITHUB_OUTPUT
        
        try {
          $existingRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/tags/$releaseName" -Headers @{Authorization = "token ${{ secrets.GITHUB_TOKEN }}"}
          echo "RELEASE_EXISTS=true" >> $env:GITHUB_OUTPUT
          echo "Release $releaseName already exists"
        } catch {
          echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
          echo "Release $releaseName does not exist"
        }

    - name: Setup build environment
      if: steps.check-release.outputs.RELEASE_EXISTS == 'false' || github.event.inputs.force_rebuild == 'true'
      run: |
        # Download 7zr.exe
        Invoke-WebRequest -Uri "https://www.7-zip.org/a/7zr.exe" -OutFile "7zr.exe"
        echo "BUILD_PATH=${{ github.workspace }}\build" >> $env:GITHUB_ENV
        New-Item -ItemType Directory -Path "${{ github.workspace }}\build" -Force

    - name: Download Chromium
      if: steps.check-release.outputs.RELEASE_EXISTS == 'false' || github.event.inputs.force_rebuild == 'true'
      run: |
        $release = Invoke-RestMethod "https://api.github.com/repos/Hibbiki/chromium-win64/releases/latest"
        $chromeAsset = $release.assets | Where-Object name -eq "chrome.7z"
        
        if (-not $chromeAsset) {
          Write-Error "chrome.7z not found!"
          exit 1
        }
        
        Write-Host "Downloading Chromium..."
        Invoke-WebRequest -Uri $chromeAsset.browser_download_url -OutFile "chrome.7z"
        
        # Extract Chromium
        .\7zr.exe x chrome.7z -o"chromium_temp" -y
        $chromeBin = Get-ChildItem -Path "chromium_temp" -Recurse -Directory -Name "Chrome-bin" | Select-Object -First 1
        
        if (-not $chromeBin) {
          Write-Error "Chrome-bin not found!"
          exit 1
        }
        
        Copy-Item "chromium_temp\$chromeBin" "$env:BUILD_PATH\Chrome" -Recurse -Force

    - name: Download Chrome++
      if: steps.check-release.outputs.RELEASE_EXISTS == 'false' || github.event.inputs.force_rebuild == 'true'
      run: |
        $release = Invoke-RestMethod "https://api.github.com/repos/Bush2021/chrome_plus/releases/latest"
        $asset = $release.assets | Where-Object { $_.name -like "*Chrome*x86_x64_arm64.7z" }
        
        if (-not $asset) {
          Write-Error "Chrome++ not found!"
          exit 1
        }
        
        Write-Host "Downloading Chrome++..."
        Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "chrome_plus.7z"
        
        # Extract Chrome++
        .\7zr.exe x chrome_plus.7z -o"chromeplus_temp" -y
        $appPath = Get-ChildItem -Path "chromeplus_temp" -Recurse -Directory | Where-Object { $_.FullName -like "*\x64\App" } | Select-Object -First 1
        
        if (-not $appPath) {
          Write-Error "x64/App not found!"
          exit 1
        }
        
        Copy-Item "$($appPath.FullName)\version.dll" "$env:BUILD_PATH\Chrome\" -Force

    - name: Download Chrome++ config and Widevine
      if: steps.check-release.outputs.RELEASE_EXISTS == 'false' || github.event.inputs.force_rebuild == 'true'
      run: |
        # Download Chrome++ config
        Invoke-WebRequest -Uri "https://github.com/bibicadotnet/Chromium-Hibbiki-Woolyss-Portable/raw/main/chrome%2B%2B.ini" -OutFile "$env:BUILD_PATH\Chrome\chrome++.ini"
        
        # Download Widevine
        Invoke-WebRequest -Uri "https://github.com/bibicadotnet/Chromium-Hibbiki-Woolyss-Portable/raw/main/WidevineCdm.7z" -OutFile "WidevineCdm.7z"
        
        # Extract Widevine
        .\7zr.exe x WidevineCdm.7z -o"widevine_temp" -y
        $version = "${{ steps.chromium-version.outputs.CHROMIUM_VERSION }}"
        $versionPath = "$env:BUILD_PATH\Chrome\$version"
        New-Item -ItemType Directory -Path $versionPath -Force
        Copy-Item "widevine_temp\WidevineCdm" "$versionPath\WidevineCdm" -Recurse -Force

    - name: Download registry optimization
      if: steps.check-release.outputs.RELEASE_EXISTS == 'false' || github.event.inputs.force_rebuild == 'true'
      run: |
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/bibicadotnet/chromium-debloat/main/disable_chromium_features.reg" -OutFile "$env:BUILD_PATH\optimize.reg"

    - name: Create portable package
      if: steps.check-release.outputs.RELEASE_EXISTS == 'false' || github.event.inputs.force_rebuild == 'true'
      run: |
        $packageName = "${{ steps.check-release.outputs.RELEASE_NAME }}"
        
        # Create 7z archive
        .\7zr.exe a -t7z "$packageName.7z" "$env:BUILD_PATH\*" -mx9
        
        echo "PACKAGE_FILE=$packageName.7z" >> $env:GITHUB_ENV

    - name: Create Release
      if: steps.check-release.outputs.RELEASE_EXISTS == 'false' || github.event.inputs.force_rebuild == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.check-release.outputs.RELEASE_NAME }}
        name: "Chromium Portable v${{ steps.chromium-version.outputs.CHROMIUM_VERSION }} + Chrome++ v${{ steps.chromeplus-version.outputs.CHROMEPLUS_VERSION }}"
        body: |
          ## Chromium Hibbiki Woolyss Portable with Chrome++
          
          **Versions:**
          - Chromium: v${{ steps.chromium-version.outputs.CHROMIUM_VERSION }}
          - Chrome++: v${{ steps.chromeplus-version.outputs.CHROMEPLUS_VERSION }}
          
          **Features:**
          - Portable Chromium browser (no system installation required)
          - Chrome++ enhancements
          - Widevine DRM support
          - Registry optimizations included
          
          **Installation:**
          1. Download the 7z file
          2. Extract to your desired location
          3. Run the optimize.reg file to apply registry settings
          4. Launch chrome.exe from the Chrome folder
          
          **Auto-built from:**
          - [Hibbiki Chromium](${{ steps.chromium-version.outputs.CHROMIUM_TAG }})
          - [Chrome++ Latest](https://github.com/Bush2021/chrome_plus/releases/latest)
        files: |
          ${{ env.PACKAGE_FILE }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup
      if: always()
      run: |
        Remove-Item -Path "chrome.7z", "chrome_plus.7z", "WidevineCdm.7z", "7zr.exe" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "chromium_temp", "chromeplus_temp", "widevine_temp", "build" -Recurse -Force -ErrorAction SilentlyContinue
